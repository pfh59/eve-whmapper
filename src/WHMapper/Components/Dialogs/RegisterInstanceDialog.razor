@using WHMapper.Models.Db.Enums
@using WHMapper.Services.EveMapper
@using WHMapper.Services.EveAPI.Characters
@using WHMapper.Models.DTO
@using WHMapper.Models.DTO.EveAPI.Character
@using MudBlazor

<MudDialog>
    <TitleContent>
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudIcon Icon="@Icons.Material.Filled.AppRegistration" />
            <MudText Typo="Typo.h6">Register Your WHMapper Instance</MudText>
        </MudStack>
    </TitleContent>
    <DialogContent>
        @if (_loading)
        {
            <MudStack AlignItems="AlignItems.Center" Class="pa-8">
                <MudProgressCircular Indeterminate="true" />
                <MudText Typo="Typo.body2" Color="Color.Secondary">Loading...</MudText>
            </MudStack>
        }
        else if (_alreadyHasInstance)
        {
            <MudAlert Severity="Severity.Info" Class="mb-4">
                <MudText>You already have an instance registered. Click "Manage Existing Instance" to configure it.</MudText>
            </MudAlert>
        }
        else if (!_isAuthenticated)
        {
            <MudAlert Severity="Severity.Warning" Class="mb-4">
                <MudText>Please log in with EVE Online to register your instance.</MudText>
            </MudAlert>
        }
        else
        {
            <MudForm @ref="_form" @bind-IsValid="_formIsValid">
                <MudText Typo="Typo.body1" Class="mb-4">
                    Create your own WHMapper instance for your character, corporation, or alliance. 
                    As the creator, you will be the administrator of this instance.
                </MudText>

                <MudTextField @bind-Value="_instanceName" 
                              Label="Instance Name" 
                              Required="true" 
                              RequiredError="Instance name is required"
                              MaxLength="255"
                              HelperText="A friendly name for your instance (e.g., 'My Corp Mapper')"
                              Class="mb-4" />

                <MudTextField @bind-Value="_description" 
                              Label="Description (optional)" 
                              Lines="3"
                              MaxLength="1000"
                              HelperText="Optional description of your instance"
                              Class="mb-4" />

                <MudSelect @bind-Value="_ownerType" 
                           Label="Instance Access Type" 
                           Required="true"
                           HelperText="Who should have access to this instance by default?"
                           Class="mb-4">
                    <MudSelectItem Value="WHAccessEntity.Character">
                        <MudIcon Icon="@Icons.Material.Filled.Person" Class="mr-2" /> Personal (Just me)
                    </MudSelectItem>
                    @if (_characterInfo?.CorporationId > 0)
                    {
                        <MudSelectItem Value="WHAccessEntity.Corporation">
                            <MudIcon Icon="@Icons.Material.Filled.Business" Class="mr-2" /> Corporation (@_corporationName)
                        </MudSelectItem>
                    }
                    @if (_characterInfo?.AllianceId > 0)
                    {
                        <MudSelectItem Value="WHAccessEntity.Alliance">
                            <MudIcon Icon="@Icons.Material.Filled.Groups" Class="mr-2" /> Alliance (@_allianceName)
                        </MudSelectItem>
                    }
                </MudSelect>

                <MudDivider Class="my-4" />

                <MudText Typo="Typo.subtitle2" Class="mb-2">
                    <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" Class="mr-1" />
                    What you get:
                </MudText>
                <MudList T="string" Dense="true">
                    <MudListItem Icon="@Icons.Material.Filled.Check">Your own isolated mapping environment</MudListItem>
                    <MudListItem Icon="@Icons.Material.Filled.Check">Full admin control over maps and access</MudListItem>
                    <MudListItem Icon="@Icons.Material.Filled.Check">Ability to add other administrators</MudListItem>
                    <MudListItem Icon="@Icons.Material.Filled.Check">Control who can access your instance</MudListItem>
                </MudList>
            </MudForm>
        }
    </DialogContent>
    <DialogActions>
        @if (_alreadyHasInstance)
        {
            <MudButton Variant="Variant.Filled" Color="Color.Info" OnClick="ManageExistingInstance">
                <MudIcon Icon="@Icons.Material.Filled.Settings" Class="mr-1" />
                Manage Existing Instance
            </MudButton>
        }
        else if (_isAuthenticated && !_loading)
        {
            <MudButton Variant="Variant.Filled" 
                       Color="Color.Primary" 
                       OnClick="RegisterInstance" 
                       Disabled="@(!_formIsValid || _registering)">
                @if (_registering)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    <span>Creating...</span>
                }
                else
                {
                    <MudIcon Icon="@Icons.Material.Filled.Add" Class="mr-1" />
                    <span>Create Instance</span>
                }
            </MudButton>
        }
        <MudSpacer />
        <MudButton Variant="Variant.Text" OnClick="Close">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = null!;

    [Inject]
    private ILogger<RegisterInstanceDialog> Logger { get; set; } = null!;

    [Inject]
    private ISnackbar Snackbar { get; set; } = null!;

    [Inject]
    private IEveMapperUserManagementService UserManagement { get; set; } = null!;

    [Inject]
    private ClientUID UID { get; set; } = null!;

    [Inject]
    private ICharacterServices CharacterServices { get; set; } = null!;

    [Inject]
    private IEveMapperService EveMapperService { get; set; } = null!;

    [Inject]
    private IEveMapperInstanceService InstanceService { get; set; } = null!;

    [Inject]
    private IDialogService DialogService { get; set; } = null!;

    private MudForm _form = null!;
    private bool _formIsValid = false;
    private bool _loading = true;
    private bool _registering = false;
    private bool _isAuthenticated = false;
    private bool _alreadyHasInstance = false;
    private int _existingInstanceId = 0;

    private string _instanceName = string.Empty;
    private string _description = string.Empty;
    private WHAccessEntity _ownerType = WHAccessEntity.Character;

    private int _characterId = 0;
    private string _characterName = string.Empty;
    private Character? _characterInfo = null;
    private string _corporationName = string.Empty;
    private string _allianceName = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadUserInfoAsync();
        await base.OnInitializedAsync();
    }

    private async Task LoadUserInfoAsync()
    {
        _loading = true;

        try
        {
            if (!string.IsNullOrEmpty(UID.ClientId))
            {
                var primaryAccount = await UserManagement.GetPrimaryAccountAsync(UID.ClientId);
                if (primaryAccount != null)
                {
                    _isAuthenticated = true;
                    _characterId = primaryAccount.Id;

                    var characterResult = await CharacterServices.GetCharacter(_characterId);
                    if (characterResult.IsSuccess && characterResult.Data != null)
                    {
                        _characterInfo = characterResult.Data;
                        _characterName = _characterInfo.Name ?? string.Empty;

                        if (_characterInfo.CorporationId > 0)
                        {
                            var corp = await EveMapperService.GetCorporation(_characterInfo.CorporationId);
                            _corporationName = corp?.Name ?? "Unknown Corporation";
                        }

                        if (_characterInfo.AllianceId > 0)
                        {
                            var alliance = await EveMapperService.GetAlliance(_characterInfo.AllianceId);
                            _allianceName = alliance?.Name ?? "Unknown Alliance";
                        }
                    }

                    var existingInstances = await InstanceService.GetAdministeredInstancesAsync(_characterId);
                    _alreadyHasInstance = existingInstances?.Any() == true;
                    if (_alreadyHasInstance && existingInstances != null)
                    {
                        _existingInstanceId = existingInstances.First().Id;
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading user info");
            Snackbar.Add("Error loading user information", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task RegisterInstance()
    {
        if (!_formIsValid || _registering)
            return;

        _registering = true;

        try
        {
            int ownerEntityId;
            string ownerEntityName;

            switch (_ownerType)
            {
                case WHAccessEntity.Character:
                    ownerEntityId = _characterId;
                    ownerEntityName = _characterName;
                    break;
                case WHAccessEntity.Corporation:
                    if (_characterInfo == null || _characterInfo.CorporationId <= 0)
                    {
                        Snackbar.Add("Corporation information not available", Severity.Error);
                        return;
                    }
                    ownerEntityId = _characterInfo.CorporationId;
                    ownerEntityName = _corporationName;
                    break;
                case WHAccessEntity.Alliance:
                    if (_characterInfo == null || _characterInfo.AllianceId <= 0)
                    {
                        Snackbar.Add("Alliance information not available", Severity.Error);
                        return;
                    }
                    ownerEntityId = _characterInfo.AllianceId;
                    ownerEntityName = _allianceName;
                    break;
                default:
                    Snackbar.Add("Invalid owner type selected", Severity.Error);
                    return;
            }

            if (!await InstanceService.CanRegisterAsync(ownerEntityId))
            {
                Snackbar.Add("An instance already exists for this entity", Severity.Warning);
                return;
            }

            var instance = await InstanceService.CreateInstanceAsync(
                _instanceName,
                string.IsNullOrWhiteSpace(_description) ? null : _description,
                ownerEntityId,
                ownerEntityName,
                _ownerType,
                _characterId,
                _characterName);

            if (instance != null)
            {
                Snackbar.Add("Instance created successfully!", Severity.Success);
                MudDialog.Close(DialogResult.Ok(instance.Id));
                
                // Open the admin dialog for the newly created instance
                var parameters = new DialogParameters<AdminInstanceDialog>
                {
                    { x => x.InstanceId, instance.Id }
                };
                var options = new DialogOptions
                {
                    MaxWidth = MaxWidth.Large,
                    FullWidth = true,
                    CloseButton = true
                };
                await DialogService.ShowAsync<AdminInstanceDialog>("Instance Administration", parameters, options);
            }
            else
            {
                Snackbar.Add("Failed to create instance", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error creating instance");
            Snackbar.Add("An error occurred while creating the instance", Severity.Error);
        }
        finally
        {
            _registering = false;
        }
    }

    private async Task ManageExistingInstance()
    {
        MudDialog.Close(DialogResult.Ok(_existingInstanceId));
        
        var parameters = new DialogParameters<AdminInstanceDialog>
        {
            { x => x.InstanceId, _existingInstanceId }
        };
        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Large,
            FullWidth = true,
            CloseButton = true
        };
        await DialogService.ShowAsync<AdminInstanceDialog>("Instance Administration", parameters, options);
    }

    private void Close() => MudDialog.Cancel();
}
