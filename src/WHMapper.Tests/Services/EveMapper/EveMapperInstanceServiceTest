using System.Threading.Tasks;
using Moq;
using WHMapper.Models.Db;
using WHMapper.Repositories.WHInstances;
using WHMapper.Repositories.WHMapAccesses;
using WHMapper.Repositories.WHMaps;
using WHMapper.Services.EveMapper;
using Xunit;
using Microsoft.Extensions.Logging;

namespace WHMapper.tests.Services.EveMapper
{
    public class EveMapperInstanceServiceTest
    {
        private readonly Mock<IWHInstanceRepository> _instanceRepoMock;
        private readonly Mock<IWHMapRepository> _mapRepoMock;
        private readonly Mock<IWHMapAccessRepository> _mapAccessRepoMock;
        private readonly Mock<ILogger<EveMapperInstanceService>> _loggerMock;
        private readonly EveMapperInstanceService _service;

        public EveMapperInstanceServiceTest()
        {
            _instanceRepoMock = new Mock<IWHInstanceRepository>();
            _mapRepoMock = new Mock<IWHMapRepository>();
            _mapAccessRepoMock = new Mock<IWHMapAccessRepository>();
            _loggerMock = new Mock<ILogger<EveMapperInstanceService>>();

            _service = new EveMapperInstanceService(
                _loggerMock.Object,
                _instanceRepoMock.Object,
                _mapRepoMock.Object,
                _mapAccessRepoMock.Object
            );
        }

        [Fact]
        public async Task GetInstanceAsync_ReturnsInstance_WhenExists()
        {
            // Arrange
            var instanceId = 1;
            var expectedInstance = new WHInstance("TestInstance", 100, "OwnerName", Models.Db.Enums.WHAccessEntity.Character, 200, "CreatorName")
            {
                Id = instanceId
            };
            _instanceRepoMock.Setup(r => r.GetById(instanceId)).ReturnsAsync(expectedInstance);

            // Act
            var result = await _service.GetInstanceAsync(instanceId);

            // Assert
            Assert.NotNull(result);
            Assert.Equal(instanceId, result.Id);
            Assert.Equal("TestInstance", result.Name);
            _instanceRepoMock.Verify(r => r.GetById(instanceId), Times.Once);
        }

        [Fact]
        public async Task GetInstanceAsync_ReturnsNull_WhenNotExists()
        {
            // Arrange
            var instanceId = 2;
            _instanceRepoMock.Setup(r => r.GetById(instanceId)).ReturnsAsync((WHInstance?)null);

            // Act
            var result = await _service.GetInstanceAsync(instanceId);

            // Assert
            Assert.Null(result);
            _instanceRepoMock.Verify(r => r.GetById(instanceId), Times.Once);
        }
    }
}